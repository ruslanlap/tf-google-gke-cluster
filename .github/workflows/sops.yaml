name: Encrypt Secret Manifest
on:
  push:
    branches:
      - main

jobs:
  encrypt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install SOPS
        run: |
          curl -LO https://github.com/mozilla/sops/releases/download/v3.7.3/sops_3.7.3_amd64.deb
          sudo dpkg -i sops_3.7.3_amd64.deb

      - name: Set KMS Path
        run: |
          export KMS_PATH="projects/tf-git/locations/global/keyRings/sops-demo/cryptoKeys/my-encryption-key"

      - name: Generate and Encrypt Secret Manifest
        env:
          MANIFEST_FILE: clusters/demo/secret-enc.yaml
          TELE_TOKEN: ${{ secrets.TELE_TOKEN }}
        run: |
          echo "apiVersion: v1" > $MANIFEST_FILE
          echo "data:" >> $MANIFEST_FILE
          echo "  token: $(echo -n $TELE_TOKEN | base64)" >> $MANIFEST_FILE

          sops --encrypt --encrypted-regex '^(data)$' --gcp-kms $KMS_PATH $MANIFEST_FILE --output secret_partial.enc.yaml

          echo "::set-output name=encrypted_manifest::$(cat secret_partial.enc.yaml)"

      - name: Create Secret
        run: |
          echo "::set-secret name=TELE_TOKEN::${{ secrets.TELE_TOKEN }}"
