name: Encrypt Secret Manifest
on:
  push:
    branches:
      - main

jobs:
  encrypt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install SOPS
        run: |
          curl -LO https://github.com/mozilla/sops/releases/download/v3.7.3/sops_3.7.3_amd64.deb
          sudo dpkg -i sops_3.7.3_amd64.deb

      - name: Generate Secret Manifest
        id: generate-manifest
        env:
          TELE_TOKEN: ${{ secrets.TELE_TOKEN }}
        run: |
          echo "apiVersion: v1" > secret.yaml
          echo "data:" >> secret.yaml
          echo "  token: $(echo -n $TELE_TOKEN | base64)" >> secret.yaml

      - name: Encrypt Secret Manifest
        id: encrypt-manifest
        env:
          MANIFEST_FILE: secret.yaml
          KMS_PATH: ${{ secrets.KMS_PATH }}
        run: |
          sops --encrypt --encrypted-regex '^(data)$' --gcp-kms $KMS_PATH $MANIFEST_FILE --output secret.enc.yaml

      - name: Set Encrypted Manifest Output
        id: set-output
        run: |
          echo "::set-output name=encrypted_manifest::$(cat secret.enc.yaml)"

      - name: Create Secret
        uses: actions/upload-artifact@v2
        with:
          name: encrypted-secret-manifest
          path: secret.enc.yaml
